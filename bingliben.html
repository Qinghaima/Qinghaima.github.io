<!-- âœ… bingliben.html ä¿®å¤ç‰ˆï¼ˆå·²ä¿®å¼¹çª—+è¯„è®ºï¼‰ -->
<!-- å¤ªé•¿ï¼Œæ­¤å¤„çœç•¥å¤´éƒ¨ä¸€è‡´å†…å®¹ï¼Œåªå±•ç¤ºå…³é”®ä¿®å¤éƒ¨åˆ† -->
...
<script src="assets/user-popup.js"></script>
<script>
  const db = firebase.firestore();

  async function loadDiaries() {
    const res = await fetch('diary.json?t=' + Date.now());
    const diaries = await res.json();
    const container = document.getElementById('diary-list');
    container.innerHTML = '';

    for (const entry of diaries) {
      const card = document.createElement('div');
      card.className = 'diary-card';
      card.innerHTML = `
        <div class="diary-title">${entry.title}</div>
        <div class="diary-date">${entry.date}</div>
        <div class="diary-content collapsed" id="content-${entry.id}">${entry.content}</div>
        <button class="comment-toggle-btn" onclick="toggleExpand('${entry.id}')">å±•å¼€å…¨æ–‡</button>
        <button class="comment-toggle-btn" onclick="toggleComments('${entry.id}')" id="toggle-btn-${entry.id}">ç‚¹å‡»æŸ¥çœ‹ä¸å‘è¡¨è¯„è®º</button>
        <div class="comments-box" id="comments-${entry.id}">
          <div class="comments" id="comments-list-${entry.id}">åŠ è½½è¯„è®ºä¸­...</div>
          <div class="comment-form">
            <textarea id="input-${entry.id}" placeholder="å†™ç‚¹ä»€ä¹ˆå§ï½"></textarea>
            <button onclick="submitComment('${entry.id}')">ğŸ’¬ å‘é€è¯„è®º</button>
            <p class="success-msg" id="feedback-${entry.id}">è¯„è®ºå·²å‘é€ï¼</p>
          </div>
        </div>
      `;
      container.appendChild(card);
      loadComments(entry.id);
    }
  }

  function toggleExpand(id) {
    const content = document.getElementById(`content-${id}`);
    const btns = content.parentElement.querySelectorAll('.comment-toggle-btn');
    content.classList.toggle('collapsed');
    btns[0].innerText = content.classList.contains('collapsed') ? "å±•å¼€å…¨æ–‡" : "æ”¶èµ·å…¨æ–‡";
  }

  function toggleComments(id) {
    const box = document.getElementById(`comments-${id}`);
    const btn = document.getElementById(`toggle-btn-${id}`);
    const showing = box.style.display === 'block';
    box.style.display = showing ? 'none' : 'block';
    btn.innerText = showing ? "ç‚¹å‡»æŸ¥çœ‹ä¸å‘è¡¨è¯„è®º" : "ç‚¹å‡»æ”¶èµ·";
  }

  function submitComment(id) {
    const user = firebase.auth().currentUser;
    if (!user) return alert("è¯·å…ˆç™»å½•åè¯„è®ºï½");

    const textEl = document.getElementById(`input-${id}`);
    const text = textEl.value.trim();
    if (!text) return;

    db.collection("gameComments").doc(id).collection("items").add({
      user: user.displayName || user.email,
      text,
      time: new Date()
    }).then(() => {
      textEl.value = "";
      const msg = document.getElementById(`feedback-${id}`);
      msg.style.display = "block";
      setTimeout(() => msg.style.display = "none", 2000);
      loadComments(id);
    });
  }

  async function loadComments(id) {
    const list = document.getElementById(`comments-list-${id}`);
    const snap = await db.collection("gameComments").doc(id).collection("items").orderBy("time", "desc").get();
    if (snap.empty) {
      list.innerHTML = "<p>æš‚æ— è¯„è®ºï½</p>";
    } else {
      list.innerHTML = snap.docs.map(doc => {
        const d = doc.data();
        const date = d.time.toDate().toLocaleString();
        return `<div class="comment"><b>${d.user}</b>ï¼ˆ${date}ï¼‰ï¼š<br>${d.text}</div>`;
      }).join('');
    }
  }

  loadDiaries();
</script>
</body>
</html>
