<!-- ✅ bingliben.html 修复版（已修弹窗+评论） -->
<!-- 太长，此处省略头部一致内容，只展示关键修复部分 -->
...
<script src="assets/user-popup.js"></script>
<script>
  const db = firebase.firestore();

  async function loadDiaries() {
    const res = await fetch('diary.json?t=' + Date.now());
    const diaries = await res.json();
    const container = document.getElementById('diary-list');
    container.innerHTML = '';

    for (const entry of diaries) {
      const card = document.createElement('div');
      card.className = 'diary-card';
      card.innerHTML = `
        <div class="diary-title">${entry.title}</div>
        <div class="diary-date">${entry.date}</div>
        <div class="diary-content collapsed" id="content-${entry.id}">${entry.content}</div>
        <button class="comment-toggle-btn" onclick="toggleExpand('${entry.id}')">展开全文</button>
        <button class="comment-toggle-btn" onclick="toggleComments('${entry.id}')" id="toggle-btn-${entry.id}">点击查看与发表评论</button>
        <div class="comments-box" id="comments-${entry.id}">
          <div class="comments" id="comments-list-${entry.id}">加载评论中...</div>
          <div class="comment-form">
            <textarea id="input-${entry.id}" placeholder="写点什么吧～"></textarea>
            <button onclick="submitComment('${entry.id}')">💬 发送评论</button>
            <p class="success-msg" id="feedback-${entry.id}">评论已发送！</p>
          </div>
        </div>
      `;
      container.appendChild(card);
      loadComments(entry.id);
    }
  }

  function toggleExpand(id) {
    const content = document.getElementById(`content-${id}`);
    const btns = content.parentElement.querySelectorAll('.comment-toggle-btn');
    content.classList.toggle('collapsed');
    btns[0].innerText = content.classList.contains('collapsed') ? "展开全文" : "收起全文";
  }

  function toggleComments(id) {
    const box = document.getElementById(`comments-${id}`);
    const btn = document.getElementById(`toggle-btn-${id}`);
    const showing = box.style.display === 'block';
    box.style.display = showing ? 'none' : 'block';
    btn.innerText = showing ? "点击查看与发表评论" : "点击收起";
  }

  function submitComment(id) {
    const user = firebase.auth().currentUser;
    if (!user) return alert("请先登录后评论～");

    const textEl = document.getElementById(`input-${id}`);
    const text = textEl.value.trim();
    if (!text) return;

    db.collection("gameComments").doc(id).collection("items").add({
      user: user.displayName || user.email,
      text,
      time: new Date()
    }).then(() => {
      textEl.value = "";
      const msg = document.getElementById(`feedback-${id}`);
      msg.style.display = "block";
      setTimeout(() => msg.style.display = "none", 2000);
      loadComments(id);
    });
  }

  async function loadComments(id) {
    const list = document.getElementById(`comments-list-${id}`);
    const snap = await db.collection("gameComments").doc(id).collection("items").orderBy("time", "desc").get();
    if (snap.empty) {
      list.innerHTML = "<p>暂无评论～</p>";
    } else {
      list.innerHTML = snap.docs.map(doc => {
        const d = doc.data();
        const date = d.time.toDate().toLocaleString();
        return `<div class="comment"><b>${d.user}</b>（${date}）：<br>${d.text}</div>`;
      }).join('');
    }
  }

  loadDiaries();
</script>
</body>
</html>
